---
- name: Check if GitLab is installed
  command: gitlab-ctl status
  register: gitlab_status
  failed_when: false
  changed_when: false

- name: Fail if GitLab is not installed
  fail:
    msg: "GitLab is not installed on this server. Use the site.yml playbook for fresh installations."
  when: gitlab_status.rc != 0

- name: Create backup directory for GitLab configs
  file:
    path: "{{ gitlab_config_backup_dir }}"
    state: directory
    mode: '0700'

- name: Backup current gitlab.rb
  copy:
    src: /etc/gitlab/gitlab.rb
    dest: "{{ gitlab_config_backup_dir }}/gitlab.rb.backup.{{ ansible_date_time.epoch }}"
    remote_src: yes
    mode: '0600'

- name: Backup current gitlab-secrets.json if it exists
  copy:
    src: /etc/gitlab/gitlab-secrets.json
    dest: "{{ gitlab_config_backup_dir }}/gitlab-secrets.json.backup.{{ ansible_date_time.epoch }}"
    remote_src: yes
    mode: '0600'
  when: ansible_check_mode == false
  ignore_errors: yes

- name: Check if gitlab-secrets.json exists
  stat:
    path: /etc/gitlab/gitlab-secrets.json
  register: secrets_file

- name: Warning if secrets file doesn't exist
  debug:
    msg: |
      WARNING: /etc/gitlab/gitlab-secrets.json not found!
      You MUST copy this file from the primary node before the secondary can work.
      Run: scp root@primary:/etc/gitlab/gitlab-secrets.json /etc/gitlab/
  when: not secrets_file.stat.exists

- name: Check if Geo is already configured
  shell: grep -q "geo_secondary_role\['enable'\] = true" /etc/gitlab/gitlab.rb
  register: geo_configured
  failed_when: false
  changed_when: false

- name: Add Geo secondary configuration to gitlab.rb
  blockinfile:
    path: /etc/gitlab/gitlab.rb
    marker: "# {mark} ANSIBLE MANAGED - GEO SECONDARY CONFIGURATION"
    block: |
      ## Geo Secondary Configuration
      geo_primary_role['enable'] = false
      geo_secondary_role['enable'] = true

      ## Geo node name
      gitlab_rails['geo_node_name'] = '{{ gitlab_geo_node_name }}'

      ## Primary database connection
      gitlab_rails['db_host'] = '{{ gitlab_primary_db_host }}'
      gitlab_rails['db_port'] = {{ gitlab_primary_db_port }}
      gitlab_rails['db_password'] = '{{ postgresql_replication_password }}'

      ## Geo secondary tracking database
      geo_secondary['db_fdw'] = true
      geo_postgresql['enable'] = true
      geo_postgresql['fdw_external_user'] = '{{ postgresql_replication_user }}'

      ## Make secondary read-only
      gitlab_rails['db_readonly'] = true
    backup: yes
  when: geo_configured.rc != 0
  notify: reconfigure gitlab

- name: Reconfigure GitLab to apply Geo settings
  command: gitlab-ctl reconfigure
  register: reconfigure_result
  changed_when: "'gitlab Reconfigured!' in reconfigure_result.stdout"

- name: Display secondary node information
  debug:
    msg: |
      ========================================
      Secondary Geo Node Configuration Complete
      ========================================

      Node Name: {{ gitlab_geo_node_name }}

      IMPORTANT NEXT STEPS:
      1. Ensure gitlab-secrets.json was copied from primary
      2. Log into PRIMARY node's Admin Area > Geo > Nodes
      3. Click "Add site" or "New site"
      4. Add this secondary node with URL: {{ gitlab_external_url | default('http://secondary.example.com') }}
      5. After adding in UI, run on this secondary:
         - gitlab-ctl reconfigure
         - gitlab-rake geo:db:create
         - gitlab-rake geo:db:migrate
         - gitlab-ctl restart
      6. Verify on primary: gitlab-rake geo:status

      Backup Location: {{ gitlab_config_backup_dir }}
      ========================================
